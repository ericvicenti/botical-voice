<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Botical Voice Agent</title>
  <script src="https://cdn.jsdelivr.net/npm/livekit-client@2/dist/livekit-client.umd.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #111;
      color: #eee;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 24px;
    }
    h1 { font-size: 1.5rem; font-weight: 400; opacity: 0.7; }
    #status {
      font-size: 1.1rem;
      opacity: 0.5;
      min-height: 1.4em;
    }
    #agent-state {
      font-size: 0.9rem;
      opacity: 0.4;
      min-height: 1.2em;
    }
    button {
      padding: 16px 48px;
      font-size: 1.1rem;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:disabled { opacity: 0.3; cursor: not-allowed; }
    #connect-btn {
      background: #4CAF50;
      color: white;
    }
    #connect-btn:hover:not(:disabled) { background: #45a049; }
    #disconnect-btn {
      background: #f44336;
      color: white;
    }
    #disconnect-btn:hover:not(:disabled) { background: #da190b; }
    .controls { display: flex; gap: 12px; }
    #transcript {
      width: 90%;
      max-width: 600px;
      height: 300px;
      overflow-y: auto;
      padding: 16px;
      background: #1a1a1a;
      border-radius: 12px;
      font-size: 0.85rem;
      line-height: 1.5;
    }
    .msg-user { color: #81D4FA; }
    .msg-agent { color: #A5D6A7; }
    .msg-system { color: #666; font-style: italic; }
    .msg-debug { color: #FFD54F; font-size: 0.8rem; }
    .msg-error { color: #EF5350; }
  </style>
</head>
<body>
  <h1>Botical</h1>
  <div id="status">Ready to connect</div>
  <div id="agent-state"></div>
  <div class="controls">
    <button id="connect-btn">Connect</button>
    <button id="disconnect-btn" disabled>Disconnect</button>
  </div>
  <div id="transcript"></div>

  <script>
    // Verify SDK loaded
    if (typeof LivekitClient === 'undefined') {
      document.getElementById('status').textContent = 'ERROR: LiveKit SDK failed to load';
      document.getElementById('status').style.color = '#EF5350';
      throw new Error('LivekitClient not defined — CDN script failed to load');
    }

    const { Room, RoomEvent, Track, ConnectionState, DisconnectReason } = LivekitClient;
    console.log('[client] LiveKit SDK loaded, version:', LivekitClient.version);

    const connectBtn = document.getElementById('connect-btn');
    const disconnectBtn = document.getElementById('disconnect-btn');
    const statusEl = document.getElementById('status');
    const agentStateEl = document.getElementById('agent-state');
    const transcriptEl = document.getElementById('transcript');

    let room = null;

    function log(text, cls = 'msg-system') {
      const time = new Date().toLocaleTimeString('en-US', { hour12: false, fractionalSecondDigits: 3 });
      const div = document.createElement('div');
      div.className = cls;
      div.textContent = `[${time}] ${text}`;
      transcriptEl.appendChild(div);
      transcriptEl.scrollTop = transcriptEl.scrollHeight;
      console.log(`[client] ${text}`);
    }

    connectBtn.onclick = async () => {
      connectBtn.disabled = true;
      statusEl.textContent = 'Fetching token...';
      log('Fetching token from /api/token...', 'msg-debug');

      try {
        const res = await fetch('/api/token');
        if (!res.ok) throw new Error(`Token API returned ${res.status}: ${await res.text()}`);
        const { token, url, identity, room: roomName } = await res.json();
        log(`Token received: identity=${identity}, room=${roomName}`, 'msg-debug');
        log(`LiveKit URL: ${url}`, 'msg-debug');

        room = new Room({
          adaptiveStream: true,
          dynacast: true,
        });

        // Connection state changes
        room.on(RoomEvent.ConnectionStateChanged, (state) => {
          log(`Connection state: ${state}`, 'msg-debug');
          statusEl.textContent = `Connection: ${state}`;
        });

        // Track subscriptions (agent audio)
        room.on(RoomEvent.TrackSubscribed, (track, publication, participant) => {
          log(`Track subscribed: ${track.kind} from ${participant.identity} (sid: ${track.sid})`, 'msg-debug');
          if (track.kind === Track.Kind.Audio) {
            const el = track.attach();
            el.style.display = 'none';
            document.body.appendChild(el);
            log(`Audio track attached from ${participant.identity}`, 'msg-system');
          }
        });

        room.on(RoomEvent.TrackUnsubscribed, (track, publication, participant) => {
          log(`Track unsubscribed: ${track.kind} from ${participant.identity}`, 'msg-debug');
          track.detach().forEach(el => el.remove());
        });

        // Track published (local)
        room.on(RoomEvent.LocalTrackPublished, (publication, participant) => {
          log(`Local track published: ${publication.kind} (sid: ${publication.trackSid})`, 'msg-debug');
        });

        // Participants
        room.on(RoomEvent.ParticipantConnected, (participant) => {
          log(`Participant joined: ${participant.identity}`, 'msg-system');
        });

        room.on(RoomEvent.ParticipantDisconnected, (participant) => {
          log(`Participant left: ${participant.identity}`, 'msg-system');
        });

        // Disconnect
        room.on(RoomEvent.Disconnected, (reason) => {
          log(`Disconnected: ${reason ?? 'unknown reason'}`, 'msg-system');
          statusEl.textContent = 'Disconnected';
          agentStateEl.textContent = '';
          connectBtn.disabled = false;
          disconnectBtn.disabled = true;
        });

        // Data messages
        room.on(RoomEvent.DataReceived, (data, participant, kind, topic) => {
          log(`Data received: topic=${topic}, from=${participant?.identity ?? 'server'}, ${data.byteLength} bytes`, 'msg-debug');
          try {
            const msg = JSON.parse(new TextDecoder().decode(data));
            if (msg.message) {
              const isAgent = participant?.identity !== room.localParticipant?.identity;
              log(msg.message, isAgent ? 'msg-agent' : 'msg-user');
            }
          } catch {}
        });

        // Transcriptions
        room.on(RoomEvent.TranscriptionReceived, (segments, participant) => {
          for (const seg of segments) {
            const who = participant?.identity === room.localParticipant?.identity ? 'You' : participant?.identity ?? 'unknown';
            if (seg.final) {
              log(`${who}: ${seg.text}`, participant?.identity === room.localParticipant?.identity ? 'msg-user' : 'msg-agent');
            } else {
              log(`${who} (interim): ${seg.text}`, 'msg-debug');
            }
          }
        });

        // Active speakers
        room.on(RoomEvent.ActiveSpeakersChanged, (speakers) => {
          if (speakers.length > 0) {
            const names = speakers.map(s => s.identity).join(', ');
            agentStateEl.textContent = `Speaking: ${names}`;
          } else {
            agentStateEl.textContent = '';
          }
        });

        // Signal reconnection
        room.on(RoomEvent.Reconnecting, () => {
          log('Reconnecting...', 'msg-debug');
        });
        room.on(RoomEvent.Reconnected, () => {
          log('Reconnected', 'msg-debug');
        });

        // Connect
        log(`Connecting to ${url}...`, 'msg-debug');
        statusEl.textContent = 'Connecting to LiveKit...';
        await room.connect(url, token);
        log(`Connected! Room: ${room.name}, Local: ${room.localParticipant.identity}`, 'msg-system');

        // List existing participants
        const remotes = Array.from(room.remoteParticipants.values());
        if (remotes.length > 0) {
          log(`${remotes.length} participant(s) already in room: ${remotes.map(p => p.identity).join(', ')}`, 'msg-debug');
        } else {
          log('No other participants in room yet (waiting for agent...)', 'msg-debug');
        }

        // Enable microphone
        log('Enabling microphone...', 'msg-debug');
        statusEl.textContent = 'Enabling microphone...';
        await room.localParticipant.setMicrophoneEnabled(true);
        log('Microphone enabled', 'msg-system');

        statusEl.textContent = `Connected as ${identity}`;
        disconnectBtn.disabled = false;
        log('Ready — speak to start a conversation', 'msg-system');
      } catch (err) {
        log(`ERROR: ${err.message}`, 'msg-error');
        statusEl.textContent = `Error: ${err.message}`;
        connectBtn.disabled = false;
        console.error('[client] Connection error:', err);
      }
    };

    disconnectBtn.onclick = () => {
      log('Disconnecting...', 'msg-debug');
      room?.disconnect();
      room = null;
    };
  </script>
</body>
</html>
